<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cruise control &mdash; Python Control Systems Library 0.10.1-8-gcc0020a documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/custom.css" />
      <link rel="stylesheet" type="text/css" href="_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Describing function analysis" href="describing_functions.html" />
    <link rel="prev" title="ERA example, mass spring damper system" href="era_msd.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Python Control Systems Library
          </a>
              <div class="version">
                0.10.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="conventions.html">Library conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="control.html">Function reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="classes.html">Control system classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="plotting.html">Plotting data</a></li>
<li class="toctree-l1"><a class="reference internal" href="matlab.html">MATLAB compatibility module</a></li>
<li class="toctree-l1"><a class="reference internal" href="flatsys.html">Differentially flat systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="iosys.html">Input/output systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="descfcn.html">Describing functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimal.html">Optimization-based control</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="examples.html#python-scripts">Python scripts</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="examples.html#jupyter-notebooks">Jupyter notebooks</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Cruise control</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Process-Model">Process Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#State-space-controller">State space controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Pole/zero-cancellation">Pole/zero cancellation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#PI-Controller">PI Controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="#PI-controller-with-antiwindup-protection">PI controller with antiwindup protection</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="describing_functions.html">Describing function analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="interconnect_tutorial.html">Interconnect Tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="kincar-fusion.html">Discrete Time Sensor Fusion</a></li>
<li class="toctree-l3"><a class="reference internal" href="mhe-pvtol.html">Moving Horizon Estimation</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpc_aircraft.html">Model Predictive Control: Aircraft Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="pvtol-lqr-nested.html">Vertical takeoff and landing aircraft</a></li>
<li class="toctree-l3"><a class="reference internal" href="pvtol-outputfbk.html">Output feedback control using LQR and extended Kalman filtering</a></li>
<li class="toctree-l3"><a class="reference internal" href="simulating_discrete_nonlinear.html">Simulating interconnections of systems</a></li>
<li class="toctree-l3"><a class="reference internal" href="steering.html">Vehicle steering</a></li>
<li class="toctree-l3"><a class="reference internal" href="stochresp.html">Stochastic Response</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#google-colab-notebooks">Google Colab Notebooks</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Python Control Systems Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="examples.html">Examples</a></li>
      <li class="breadcrumb-item active">Cruise control</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/cruise.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="Cruise-control">
<h1>Cruise control<a class="headerlink" href="#Cruise-control" title="Permalink to this heading">¶</a></h1>
<div class="line-block">
<div class="line">Richard M. Murray and Karl J. Åström</div>
<div class="line">17 Jun 2019</div>
</div>
<p>The cruise control system of a car is a common feedback system encountered in everyday life. The system attempts to maintain a constant velocity in the presence of disturbances primarily caused by changes in the slope of a road. The controller compensates for these unknowns by measuring the speed of the car and adjusting the throttle appropriately.</p>
<p>This notebook explores the dynamics and control of the cruise control system, following the material presenting in Feedback Systems by Astrom and Murray. A nonlinear model of the vehicle dynamics is used, with both state space and frequency domain control laws. The process model is presented in Section 1, and a controller based on state feedback is discussed in Section 2, where we also add integral action to the controller. In Section 3 we explore the behavior with PI control including the
effect of actuator saturation and how it is avoided by windup protection. Different methods of constructing control systems are shown, all using the InputOutputSystem class (and subclasses).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>
<span class="kn">import</span> <span class="nn">control</span> <span class="k">as</span> <span class="nn">ct</span>
</pre></div>
</div>
</div>
<div class="section" id="Process-Model">
<h2>Process Model<a class="headerlink" href="#Process-Model" title="Permalink to this heading">¶</a></h2>
<div class="section" id="Vehicle-Dynamics">
<h3>Vehicle Dynamics<a class="headerlink" href="#Vehicle-Dynamics" title="Permalink to this heading">¶</a></h3>
<p>To develop a mathematical model we start with a force balance for the car body. Let <span class="math">v</span> be the speed of the car, <span class="math">m</span> the total mass (including passengers), <span class="math">F</span> the force generated by the contact of the wheels with the road, and <span class="math">F_d</span> the disturbance force due to gravity, friction, and aerodynamic drag.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vehicle_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Vehicle dynamics for cruise control system.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array</span>
<span class="sd">         System state: car velocity in m/s</span>
<span class="sd">    u : array</span>
<span class="sd">         System input: [throttle, gear, road_slope], where throttle is</span>
<span class="sd">         a float between 0 and 1, gear is an integer between 1 and 5,</span>
<span class="sd">         and road_slope is in rad.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Vehicle acceleration</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">copysign</span><span class="p">,</span> <span class="n">sin</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">copysign</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>         <span class="c1"># define the sign() function</span>

    <span class="c1"># Set up the system parameters</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="mf">1600.</span><span class="p">)</span>              <span class="c1"># vehicle mass, kg</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="mf">9.8</span><span class="p">)</span>                <span class="c1"># gravitational constant, m/s^2</span>
    <span class="n">Cr</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Cr&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>             <span class="c1"># coefficient of rolling friction</span>
    <span class="n">Cd</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Cd&#39;</span><span class="p">,</span> <span class="mf">0.32</span><span class="p">)</span>             <span class="c1"># drag coefficient</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rho&#39;</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">)</span>            <span class="c1"># density of air, kg/m^3</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">)</span>                <span class="c1"># car area, m^2</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>      <span class="c1"># gear ratio / wheel radius</span>

    <span class="c1"># Define variables for vehicle state and inputs</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                           <span class="c1"># vehicle velocity</span>
    <span class="n">throttle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>     <span class="c1"># vehicle throttle</span>
    <span class="n">gear</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>                        <span class="c1"># vehicle gear</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>                       <span class="c1"># road slope</span>

    <span class="c1"># Force generated by the engine</span>

    <span class="n">omega</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">gear</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>      <span class="c1"># engine angular speed</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">gear</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">motor_torque</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">*</span> <span class="n">throttle</span>

    <span class="c1"># Disturbance forces</span>
    <span class="c1">#</span>
    <span class="c1"># The disturbance force Fd has three major components: Fg, the forces due</span>
    <span class="c1"># to gravity; Fr, the forces due to rolling friction; and Fa, the</span>
    <span class="c1"># aerodynamic drag.</span>

    <span class="c1"># Letting the slope of the road be \theta (theta), gravity gives the</span>
    <span class="c1"># force Fg = m g sin \theta.</span>

    <span class="n">Fg</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

    <span class="c1"># A simple model of rolling friction is Fr = m g Cr sgn(v), where Cr is</span>
    <span class="c1"># the coefficient of rolling friction and sgn(v) is the sign of v (±1) or</span>
    <span class="c1"># zero if v = 0.</span>

    <span class="n">Fr</span>  <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="n">Cr</span> <span class="o">*</span> <span class="n">sign</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="c1"># The aerodynamic drag is proportional to the square of the speed: Fa =</span>
    <span class="c1"># 1/2 \rho Cd A |v| v, where \rho is the density of air, Cd is the</span>
    <span class="c1"># shape-dependent aerodynamic drag coefficient, and A is the frontal area</span>
    <span class="c1"># of the car.</span>

    <span class="n">Fa</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">Cd</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span>

    <span class="c1"># Final acceleration on the car</span>
    <span class="n">Fd</span> <span class="o">=</span> <span class="n">Fg</span> <span class="o">+</span> <span class="n">Fr</span> <span class="o">+</span> <span class="n">Fa</span>
    <span class="n">dv</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span> <span class="o">-</span> <span class="n">Fd</span><span class="p">)</span> <span class="o">/</span> <span class="n">m</span>

    <span class="k">return</span> <span class="n">dv</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Engine-model">
<h3>Engine model<a class="headerlink" href="#Engine-model" title="Permalink to this heading">¶</a></h3>
<p>The force F is generated by the engine, whose torque is proportional to the rate of fuel injection, which is itself proportional to a control signal 0 &lt;= u &lt;= 1 that controls the throttle position. The torque also depends on engine speed omega.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">motor_torque</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{}):</span>
    <span class="c1"># Set up the system parameters</span>
    <span class="n">Tm</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Tm&#39;</span><span class="p">,</span> <span class="mf">190.</span><span class="p">)</span>             <span class="c1"># engine torque constant</span>
    <span class="n">omega_m</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;omega_m&#39;</span><span class="p">,</span> <span class="mf">420.</span><span class="p">)</span>   <span class="c1"># peak engine angular speed</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>          <span class="c1"># peak engine rolloff</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">Tm</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">omega</span><span class="o">/</span><span class="n">omega_m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Torque curves for a typical car engine. The graph on the left shows the torque generated by the engine as a function of the angular velocity of the engine, while the curve on the right shows torque as a function of car speed for different gears.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figure 4.2</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># (a) - single torque curve as function of omega</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">701</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">motor_torque</span><span class="p">(</span><span class="n">omega</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Angular velocity $\omega$ [rad/s]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Torque $T$ [Nm]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">)</span>

<span class="c1"># (b) - torque curves in different gears, as function of velocity</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">)</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="k">for</span> <span class="n">gear</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="n">gear</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">motor_torque</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>

<span class="c1"># Set up the axes and style</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">)</span>

<span class="c1"># Add labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">11.5</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="s1">&#39;$n$=1&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="s1">&#39;$n$=2&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">42.5</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="s1">&#39;$n$=3&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">58.5</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="s1">&#39;$n$=4&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">58.5</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="s1">&#39;$n$=5&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Velocity $v$ [m/s]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Torque $T$ [Nm]&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Torque curves for typical car engine&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/cruise_7_0.png" src="_images/cruise_7_0.png" />
</div>
</div>
</div>
<div class="section" id="Input/ouput-model-for-the-vehicle-system">
<h3>Input/ouput model for the vehicle system<a class="headerlink" href="#Input/ouput-model-for-the-vehicle-system" title="Permalink to this heading">¶</a></h3>
<p>We now create an input/output model for the vehicle system that takes the throttle input <span class="math">u</span>, the gear and the angle of the road <span class="math">\theta</span> as input. The output of this model is the current vehicle velocity <span class="math">v</span>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vehicle</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">NonlinearIOSystem</span><span class="p">(</span>
    <span class="n">vehicle_update</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;vehicle&#39;</span><span class="p">,</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;gear&#39;</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">),</span> <span class="n">outputs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">),</span> <span class="n">states</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">))</span>

<span class="c1"># Define a function for creating a &quot;standard&quot; cruise control plot</span>
<span class="k">def</span> <span class="nf">cruise_plot</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_hill</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vref</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">antiwindup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">linetype</span><span class="o">=</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">subplots</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subplots</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="c1"># Figure out the plot bounds and indices</span>
    <span class="n">v_min</span> <span class="o">=</span> <span class="n">vref</span> <span class="o">-</span> <span class="mf">1.2</span><span class="p">;</span> <span class="n">v_max</span> <span class="o">=</span> <span class="n">vref</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">;</span> <span class="n">v_ind</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">find_output</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)</span>
    <span class="n">u_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">u_max</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">antiwindup</span> <span class="k">else</span> <span class="mi">1</span><span class="p">;</span> <span class="n">u_ind</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">find_output</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>

    <span class="c1"># Make sure the upper and lower bounds on v are OK</span>
    <span class="k">while</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">v_ind</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">v_max</span><span class="p">:</span> <span class="n">v_max</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="nb">min</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">v_ind</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">v_min</span><span class="p">:</span> <span class="n">v_min</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="c1"># Create arrays for return values</span>
    <span class="n">subplot_axes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">subplots</span><span class="p">)</span>

    <span class="c1"># Velocity profile</span>
    <span class="k">if</span> <span class="n">subplot_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subplot_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">subplots</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">v_ind</span><span class="p">],</span> <span class="n">linetype</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">vref</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t_hill</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_hill</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;t hill&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time $t$ [s]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Velocity $v$ [m/s]&#39;</span><span class="p">)</span>

    <span class="c1"># Commanded input profile</span>
    <span class="k">if</span> <span class="n">subplot_axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subplot_axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">subplots</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">u_ind</span><span class="p">],</span> <span class="s1">&#39;r--&#39;</span> <span class="k">if</span> <span class="n">antiwindup</span> <span class="k">else</span> <span class="n">linetype</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="c1"># Applied input profile</span>
    <span class="k">if</span> <span class="n">antiwindup</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">u_ind</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">linetype</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Applied&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t_hill</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_hill</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">u_min</span><span class="p">,</span> <span class="n">u_max</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time $t$ [s]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Throttle $u$&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">subplot_axes</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="State-space-controller">
<h2>State space controller<a class="headerlink" href="#State-space-controller" title="Permalink to this heading">¶</a></h2>
<p>Construct a state space controller with integral action, linearized around an equilibrium point. The controller is constructed around the equilibrium point <span class="math">(x_d, u_d)</span> and includes both feedforward and feedback compensation.</p>
<ul class="simple">
<li><p>Controller inputs - <span class="math">(x, y, r)</span>: system states, system output, reference</p></li>
<li><p>Controller state - <span class="math">z</span>: integrated error <span class="math">(y - r)</span></p></li>
<li><p>Controller output - <span class="math">u</span>: state feedback control</p></li>
</ul>
<p>Note: to make the structure of the controller more clear, we implement this as a “nonlinear” input/output module, even though the actual input/output system is linear. This also allows the use of parameters to set the operating point and gains for the controller.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sf_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{}):</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">y</span> <span class="o">-</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">sf_output</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{}):</span>
    <span class="c1"># Get the controller parameters that we need</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ki</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ki&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">kf</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kf&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">xd</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xd&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">yd</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;yd&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ud</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ud&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Get the system state and reference input</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ud</span> <span class="o">-</span> <span class="n">K</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">xd</span><span class="p">)</span> <span class="o">-</span> <span class="n">ki</span> <span class="o">*</span> <span class="n">z</span> <span class="o">+</span> <span class="n">kf</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">yd</span><span class="p">)</span>

<span class="c1"># Create the input/output system for the controller</span>
<span class="n">control_sf</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">NonlinearIOSystem</span><span class="p">(</span>
    <span class="n">sf_update</span><span class="p">,</span> <span class="n">sf_output</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;control&#39;</span><span class="p">,</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">),</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">),</span>
    <span class="n">states</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">))</span>

<span class="c1"># Create the closed loop system for the state space controller</span>
<span class="n">cruise_sf</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">InterconnectedSystem</span><span class="p">(</span>
    <span class="p">[</span><span class="n">vehicle</span><span class="p">,</span> <span class="n">control_sf</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cruise&#39;</span><span class="p">,</span>
    <span class="n">connections</span><span class="o">=</span><span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;vehicle.u&#39;</span><span class="p">,</span> <span class="s1">&#39;control.u&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;control.x&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.v&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;control.y&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.v&#39;</span><span class="p">]],</span>
    <span class="n">inplist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;control.r&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.gear&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.theta&#39;</span><span class="p">],</span>
    <span class="n">outlist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;control.u&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.v&#39;</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">])</span>

<span class="c1"># Define the time and input vectors</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">501</span><span class="p">)</span>
<span class="n">vref</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">gear</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">theta0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Find the equilibrium point for the system</span>
<span class="n">Xeq</span><span class="p">,</span> <span class="n">Ueq</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">find_eqpt</span><span class="p">(</span>
    <span class="n">vehicle</span><span class="p">,</span> <span class="p">[</span><span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">gear</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">theta0</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y0</span><span class="o">=</span><span class="p">[</span><span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">iu</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Xeq = &quot;</span><span class="p">,</span> <span class="n">Xeq</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ueq = &quot;</span><span class="p">,</span> <span class="n">Ueq</span><span class="p">)</span>

<span class="c1"># Compute the linearized system at the eq pt</span>
<span class="n">cruise_linearized</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">linearize</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span> <span class="n">Xeq</span><span class="p">,</span> <span class="p">[</span><span class="n">Ueq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gear</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Xeq =  [20.]
Ueq =  [0.16874874 4.         0.        ]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Construct the gain matrices for the system</span>
<span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">cruise_linearized</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">cruise_linearized</span><span class="o">.</span><span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cruise_linearized</span><span class="o">.</span><span class="n">C</span>
<span class="n">K</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">kf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">B</span> <span class="o">*</span> <span class="n">K</span><span class="p">)</span> <span class="o">*</span> <span class="n">B</span><span class="p">)</span>

<span class="c1"># Compute the steady state velocity and throttle setting</span>
<span class="n">xd</span> <span class="o">=</span> <span class="n">Xeq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ud</span> <span class="o">=</span> <span class="n">Ueq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">yd</span> <span class="o">=</span> <span class="n">vref</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Response of the system with no integral feedback term</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">theta_hill</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">0</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">5</span> <span class="k">else</span>
    <span class="mf">4.</span><span class="o">/</span><span class="mf">180.</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">6</span> <span class="k">else</span>
    <span class="mf">4.</span><span class="o">/</span><span class="mf">180.</span> <span class="o">*</span> <span class="n">pi</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">T</span><span class="p">]</span>
<span class="n">t</span><span class="p">,</span> <span class="n">y_sfb</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">input_output_response</span><span class="p">(</span>
    <span class="n">cruise_sf</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">vref</span><span class="p">,</span> <span class="n">gear</span><span class="p">,</span> <span class="n">theta_hill</span><span class="p">],</span> <span class="p">[</span><span class="n">Xeq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;K&#39;</span><span class="p">:</span><span class="n">K</span><span class="p">,</span> <span class="s1">&#39;ki&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;kf&#39;</span><span class="p">:</span><span class="n">kf</span><span class="p">,</span> <span class="s1">&#39;xd&#39;</span><span class="p">:</span><span class="n">xd</span><span class="p">,</span> <span class="s1">&#39;ud&#39;</span><span class="p">:</span><span class="n">ud</span><span class="p">,</span> <span class="s1">&#39;yd&#39;</span><span class="p">:</span><span class="n">yd</span><span class="p">})</span>
<span class="n">subplots</span> <span class="o">=</span> <span class="n">cruise_plot</span><span class="p">(</span><span class="n">cruise_sf</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y_sfb</span><span class="p">,</span> <span class="n">t_hill</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">linetype</span><span class="o">=</span><span class="s1">&#39;b--&#39;</span><span class="p">)</span>

<span class="c1"># Response of the system with state feedback + integral action</span>
<span class="n">t</span><span class="p">,</span> <span class="n">y_sfb_int</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">input_output_response</span><span class="p">(</span>
    <span class="n">cruise_sf</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">vref</span><span class="p">,</span> <span class="n">gear</span><span class="p">,</span> <span class="n">theta_hill</span><span class="p">],</span> <span class="p">[</span><span class="n">Xeq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;K&#39;</span><span class="p">:</span><span class="n">K</span><span class="p">,</span> <span class="s1">&#39;ki&#39;</span><span class="p">:</span><span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;kf&#39;</span><span class="p">:</span><span class="n">kf</span><span class="p">,</span> <span class="s1">&#39;xd&#39;</span><span class="p">:</span><span class="n">xd</span><span class="p">,</span> <span class="s1">&#39;ud&#39;</span><span class="p">:</span><span class="n">ud</span><span class="p">,</span> <span class="s1">&#39;yd&#39;</span><span class="p">:</span><span class="n">yd</span><span class="p">})</span>
<span class="n">cruise_plot</span><span class="p">(</span><span class="n">cruise_sf</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y_sfb_int</span><span class="p">,</span> <span class="n">t_hill</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">linetype</span><span class="o">=</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="n">subplots</span><span class="p">)</span>

<span class="c1"># Add title and legend</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Cruise control with state feedback, integral action&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.lines</span> <span class="k">as</span> <span class="nn">mlines</span>
<span class="n">p_line</span> <span class="o">=</span> <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;State feedback&#39;</span><span class="p">)</span>
<span class="n">pi_line</span> <span class="o">=</span> <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;w/ integral action&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">p_line</span><span class="p">,</span> <span class="n">pi_line</span><span class="p">],</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/cruise_12_0.png" src="_images/cruise_12_0.png" />
</div>
</div>
</div>
<div class="section" id="Pole/zero-cancellation">
<h2>Pole/zero cancellation<a class="headerlink" href="#Pole/zero-cancellation" title="Permalink to this heading">¶</a></h2>
<p>The transfer function for the linearized dynamics of the cruise control system is given by <span class="math">P(s) = b/(s+a)</span>. A simple (but not necessarily good) way to design a PI controller is to choose the parameters of the PI controller as <span class="math">k_\text{i}=ak_\text{p}</span>. The controller transfer function is then <span class="math">C(s)=k_\text{p}+k_\text{i}/s=k_\text{i}(s+a)/s</span>. It has a zero at <span class="math">s = -k_\text{i}/k_\text{p}=-a</span> that cancels the process pole at <span class="math">s = -a</span>. We have
<span class="math">P(s)C(s)=k_\text{i}/s</span> giving the transfer function from reference to vehicle velocity as <span class="math">G_{yr}(s)=b k_\text{p}/(s + b k_\text{p})</span>, and control design is then simply a matter of choosing the gain <span class="math">k_\text{p}</span>. The closed loop system dynamics are of first order with the time constant <span class="math">1/(b k_\text{p})</span>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the transfer function from throttle input + hill to vehicle speed</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ss2tf</span><span class="p">(</span><span class="n">cruise_linearized</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

<span class="c1"># Construction a controller that cancels the pole</span>
<span class="n">kp</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">poles</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">P</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">*</span> <span class="n">a</span>
<span class="n">ki</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">kp</span>
<span class="n">control_pz</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">TransferFunction</span><span class="p">(</span>
    <span class="p">[</span><span class="n">kp</span><span class="p">,</span> <span class="n">ki</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;control&#39;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;system: a = &quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="s2">&quot;, b = &quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pzcancel: kp =&quot;</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="s2">&quot;, ki =&quot;</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="s2">&quot;, 1/(kp b) = &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">kp</span> <span class="o">*</span> <span class="n">b</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sfb_int: K = &quot;</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="s2">&quot;, ki = 0.1&quot;</span><span class="p">)</span>

<span class="c1"># Construct the closed loop system and plot the response</span>
<span class="c1"># Create the closed loop system for the state space controller</span>
<span class="n">cruise_pz</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">InterconnectedSystem</span><span class="p">(</span>
    <span class="p">[</span><span class="n">vehicle</span><span class="p">,</span> <span class="n">control_pz</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cruise_pz&#39;</span><span class="p">,</span>
    <span class="n">connections</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;control.u&#39;</span><span class="p">,</span> <span class="s1">&#39;-vehicle.v&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;vehicle.u&#39;</span><span class="p">,</span> <span class="s1">&#39;control.y&#39;</span><span class="p">]],</span>
    <span class="n">inplist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;control.u&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.gear&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.theta&#39;</span><span class="p">],</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;vref&#39;</span><span class="p">,</span> <span class="s1">&#39;gear&#39;</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">],</span>
    <span class="n">outlist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;vehicle.v&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.u&#39;</span><span class="p">],</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">])</span>

<span class="c1"># Find the equilibrium point</span>
<span class="n">X0</span><span class="p">,</span> <span class="n">U0</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">find_eqpt</span><span class="p">(</span>
    <span class="n">cruise_pz</span><span class="p">,</span> <span class="p">[</span><span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gear</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">theta0</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
    <span class="n">iu</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">y0</span><span class="o">=</span><span class="p">[</span><span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">iy</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Response of the system with PI controller canceling process pole</span>
<span class="n">t</span><span class="p">,</span> <span class="n">y_pzcancel</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">input_output_response</span><span class="p">(</span>
    <span class="n">cruise_pz</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">vref</span><span class="p">,</span> <span class="n">gear</span><span class="p">,</span> <span class="n">theta_hill</span><span class="p">],</span> <span class="n">X0</span><span class="p">)</span>
<span class="n">subplots</span> <span class="o">=</span> <span class="n">cruise_plot</span><span class="p">(</span><span class="n">cruise_pz</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y_pzcancel</span><span class="p">,</span> <span class="n">t_hill</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">linetype</span><span class="o">=</span><span class="s1">&#39;b-&#39;</span><span class="p">)</span>
<span class="n">cruise_plot</span><span class="p">(</span><span class="n">cruise_sf</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y_sfb_int</span><span class="p">,</span> <span class="n">t_hill</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">linetype</span><span class="o">=</span><span class="s1">&#39;b--&#39;</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="n">subplots</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
system: a =  (0.010124405669387215-0j) , b =  (1.3203061238159202+0j)
pzcancel: kp = 0.5 , ki = (0.005062202834693608+0j) , 1/(kp b) =  (1.5148002148317266+0j)
sfb_int: K =  0.5 , ki = 0.1
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/murray/src/python-control/murrayrm/control/xferfcn.py:1109: ComplexWarning: Casting complex values to real discards the imaginary part
  num[i, j, maxindex+1-len(numpoly):maxindex+1] = numpoly
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/cruise_14_2.png" src="_images/cruise_14_2.png" />
</div>
</div>
</div>
<div class="section" id="PI-Controller">
<h2>PI Controller<a class="headerlink" href="#PI-Controller" title="Permalink to this heading">¶</a></h2>
<p>In this example, the speed of the vehicle is measured and compared to the desired speed. The controller is a PI controller represented as a transfer function. In the textbook, the simulations are done for LTI systems, but here we simulate the full nonlinear system.</p>
<div class="section" id="Parameter-design-through-pole-placement">
<h3>Parameter design through pole placement<a class="headerlink" href="#Parameter-design-through-pole-placement" title="Permalink to this heading">¶</a></h3>
<p>To illustrate the design of a PI controller, we choose the gains <span class="math">k_\text{p}</span> and <span class="math">k_\text{i}</span> so that the characteristic polynomial has the form</p>
<div class="math">
<p><span class="math">s^2 + 2 \zeta \omega_0 s + \omega_0^2</span></p>
</div><div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Values of the first order transfer function P(s) = b/(s + a) are set above</span>

<span class="c1"># Define the input that we want to track</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">vref</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">gear</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">theta_hill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="mi">0</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">5</span> <span class="k">else</span>
    <span class="mf">4.</span><span class="o">/</span><span class="mf">180.</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">6</span> <span class="k">else</span>
    <span class="mf">4.</span><span class="o">/</span><span class="mf">180.</span> <span class="o">*</span> <span class="n">pi</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">T</span><span class="p">])</span>

<span class="c1"># Fix \omega_0 and vary \zeta</span>
<span class="n">w0</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">subplots</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="k">for</span> <span class="n">zeta</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
    <span class="c1"># Create the controller transfer function (as an I/O system)</span>
    <span class="n">kp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">zeta</span><span class="o">*</span><span class="n">w0</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">b</span>
    <span class="n">ki</span> <span class="o">=</span> <span class="n">w0</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">b</span>
    <span class="n">control_tf</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">TransferFunction</span><span class="p">(</span>
        <span class="p">[</span><span class="n">kp</span><span class="p">,</span> <span class="n">ki</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.01</span><span class="o">*</span><span class="n">ki</span><span class="o">/</span><span class="n">kp</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;control&#39;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

    <span class="c1"># Construct the closed loop system by interconnecting process and controller</span>
    <span class="n">cruise_tf</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">InterconnectedSystem</span><span class="p">(</span>
    <span class="p">[</span><span class="n">vehicle</span><span class="p">,</span> <span class="n">control_tf</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cruise&#39;</span><span class="p">,</span>
    <span class="n">connections</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;control.u&#39;</span><span class="p">,</span> <span class="s1">&#39;-vehicle.v&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;vehicle.u&#39;</span><span class="p">,</span> <span class="s1">&#39;control.y&#39;</span><span class="p">]],</span>
    <span class="n">inplist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;control.u&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.gear&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.theta&#39;</span><span class="p">],</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;vref&#39;</span><span class="p">,</span> <span class="s1">&#39;gear&#39;</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">],</span>
    <span class="n">outlist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;vehicle.v&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.u&#39;</span><span class="p">],</span> <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">])</span>

    <span class="c1"># Plot the velocity response</span>
    <span class="n">X0</span><span class="p">,</span> <span class="n">U0</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">find_eqpt</span><span class="p">(</span>
        <span class="n">cruise_tf</span><span class="p">,</span> <span class="p">[</span><span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gear</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">theta_hill</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="n">iu</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">y0</span><span class="o">=</span><span class="p">[</span><span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">iy</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">t</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">input_output_response</span><span class="p">(</span><span class="n">cruise_tf</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">vref</span><span class="p">,</span> <span class="n">gear</span><span class="p">,</span> <span class="n">theta_hill</span><span class="p">],</span> <span class="n">X0</span><span class="p">)</span>
    <span class="n">subplots</span> <span class="o">=</span> <span class="n">cruise_plot</span><span class="p">(</span><span class="n">cruise_tf</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t_hill</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="n">subplots</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/murray/src/python-control/murrayrm/control/xferfcn.py:1109: ComplexWarning: Casting complex values to real discards the imaginary part
  num[i, j, maxindex+1-len(numpoly):maxindex+1] = numpoly
/Users/murray/src/python-control/murrayrm/control/xferfcn.py:1109: ComplexWarning: Casting complex values to real discards the imaginary part
  num[i, j, maxindex+1-len(numpoly):maxindex+1] = numpoly
/Users/murray/src/python-control/murrayrm/control/xferfcn.py:1109: ComplexWarning: Casting complex values to real discards the imaginary part
  num[i, j, maxindex+1-len(numpoly):maxindex+1] = numpoly
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/cruise_17_1.png" src="_images/cruise_17_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fix \zeta and vary \omega_0</span>
<span class="n">zeta</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">subplots</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="k">for</span> <span class="n">w0</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
    <span class="c1"># Create the controller transfer function (as an I/O system)</span>
    <span class="n">kp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">zeta</span><span class="o">*</span><span class="n">w0</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">b</span>
    <span class="n">ki</span> <span class="o">=</span> <span class="n">w0</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">b</span>
    <span class="n">control_tf</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">TransferFunction</span><span class="p">(</span>
        <span class="p">[</span><span class="n">kp</span><span class="p">,</span> <span class="n">ki</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.01</span><span class="o">*</span><span class="n">ki</span><span class="o">/</span><span class="n">kp</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;control&#39;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

    <span class="c1"># Construct the closed loop system by interconnecting process and controller</span>
    <span class="n">cruise_tf</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">InterconnectedSystem</span><span class="p">(</span>
    <span class="p">[</span><span class="n">vehicle</span><span class="p">,</span> <span class="n">control_tf</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cruise&#39;</span><span class="p">,</span>
    <span class="n">connections</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;control.u&#39;</span><span class="p">,</span> <span class="s1">&#39;-vehicle.v&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;vehicle.u&#39;</span><span class="p">,</span> <span class="s1">&#39;control.y&#39;</span><span class="p">]],</span>
    <span class="n">inplist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;control.u&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.gear&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.theta&#39;</span><span class="p">],</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;vref&#39;</span><span class="p">,</span> <span class="s1">&#39;gear&#39;</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">],</span>
    <span class="n">outlist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;vehicle.v&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.u&#39;</span><span class="p">],</span> <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">])</span>

    <span class="c1"># Plot the velocity response</span>
    <span class="n">X0</span><span class="p">,</span> <span class="n">U0</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">find_eqpt</span><span class="p">(</span>
        <span class="n">cruise_tf</span><span class="p">,</span> <span class="p">[</span><span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gear</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">theta_hill</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="n">iu</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">y0</span><span class="o">=</span><span class="p">[</span><span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">iy</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">t</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">input_output_response</span><span class="p">(</span><span class="n">cruise_tf</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">vref</span><span class="p">,</span> <span class="n">gear</span><span class="p">,</span> <span class="n">theta_hill</span><span class="p">],</span> <span class="n">X0</span><span class="p">)</span>
    <span class="n">subplots</span> <span class="o">=</span> <span class="n">cruise_plot</span><span class="p">(</span><span class="n">cruise_tf</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t_hill</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="n">subplots</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/murray/src/python-control/murrayrm/control/xferfcn.py:1109: ComplexWarning: Casting complex values to real discards the imaginary part
  num[i, j, maxindex+1-len(numpoly):maxindex+1] = numpoly
/Users/murray/src/python-control/murrayrm/control/xferfcn.py:1109: ComplexWarning: Casting complex values to real discards the imaginary part
  num[i, j, maxindex+1-len(numpoly):maxindex+1] = numpoly
/Users/murray/src/python-control/murrayrm/control/xferfcn.py:1109: ComplexWarning: Casting complex values to real discards the imaginary part
  num[i, j, maxindex+1-len(numpoly):maxindex+1] = numpoly
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/cruise_18_1.png" src="_images/cruise_18_1.png" />
</div>
</div>
</div>
<div class="section" id="Robustness-to-change-in-mass">
<h3>Robustness to change in mass<a class="headerlink" href="#Robustness-to-change-in-mass" title="Permalink to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Nominal controller design for remaining analyses</span>
<span class="c1"># Construct a PI controller with rolloff, as a transfer function</span>
<span class="n">Kp</span> <span class="o">=</span> <span class="mf">0.5</span>                        <span class="c1"># proportional gain</span>
<span class="n">Ki</span> <span class="o">=</span> <span class="mf">0.1</span>                        <span class="c1"># integral gain</span>
<span class="n">control_tf</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">TransferFunction</span><span class="p">(</span>
    <span class="p">[</span><span class="n">Kp</span><span class="p">,</span> <span class="n">Ki</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.01</span><span class="o">*</span><span class="n">Ki</span><span class="o">/</span><span class="n">Kp</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;control&#39;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

<span class="n">cruise_tf</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">InterconnectedSystem</span><span class="p">(</span>
    <span class="p">[</span><span class="n">vehicle</span><span class="p">,</span> <span class="n">control_tf</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cruise&#39;</span><span class="p">,</span>
    <span class="n">connections</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;control.u&#39;</span><span class="p">,</span> <span class="s1">&#39;-vehicle.v&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;vehicle.u&#39;</span><span class="p">,</span> <span class="s1">&#39;control.y&#39;</span><span class="p">]],</span>
    <span class="n">inplist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;control.u&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.gear&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.theta&#39;</span><span class="p">],</span> <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;vref&#39;</span><span class="p">,</span> <span class="s1">&#39;gear&#39;</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">],</span>
    <span class="n">outlist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;vehicle.v&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.u&#39;</span><span class="p">],</span> <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the time and input vectors</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">vref</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">gear</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">theta0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Now simulate the effect of a hill at t = 5 seconds</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Response to change in road slope&#39;</span><span class="p">)</span>
<span class="n">theta_hill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="mi">0</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">5</span> <span class="k">else</span>
    <span class="mf">4.</span><span class="o">/</span><span class="mf">180.</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">6</span> <span class="k">else</span>
    <span class="mf">4.</span><span class="o">/</span><span class="mf">180.</span> <span class="o">*</span> <span class="n">pi</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">T</span><span class="p">])</span>

<span class="n">subplots</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">linecolor</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">]</span>
<span class="n">handles</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">2000</span><span class="p">]):</span>
    <span class="c1"># Compute the equilibrium state for the system</span>
    <span class="n">X0</span><span class="p">,</span> <span class="n">U0</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">find_eqpt</span><span class="p">(</span>
        <span class="n">cruise_tf</span><span class="p">,</span> <span class="p">[</span><span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gear</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">theta0</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="n">iu</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">y0</span><span class="o">=</span><span class="p">[</span><span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">iy</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span><span class="n">m</span><span class="p">})</span>

    <span class="n">t</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">input_output_response</span><span class="p">(</span>
        <span class="n">cruise_tf</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">vref</span><span class="p">,</span> <span class="n">gear</span><span class="p">,</span> <span class="n">theta_hill</span><span class="p">],</span> <span class="n">X0</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span><span class="n">m</span><span class="p">})</span>

    <span class="n">subplots</span> <span class="o">=</span> <span class="n">cruise_plot</span><span class="p">(</span><span class="n">cruise_tf</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t_hill</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="n">subplots</span><span class="p">,</span>
                           <span class="n">linetype</span><span class="o">=</span><span class="n">linecolor</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="n">linecolor</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
                                 <span class="n">label</span><span class="o">=</span><span class="s2">&quot;m = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">m</span><span class="p">))</span>

<span class="c1"># Add labels to the plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">subplots</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Speed [m/s]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">subplots</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Throttle&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/cruise_21_0.png" src="_images/cruise_21_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="PI-controller-with-antiwindup-protection">
<h2>PI controller with antiwindup protection<a class="headerlink" href="#PI-controller-with-antiwindup-protection" title="Permalink to this heading">¶</a></h2>
<p>We now create a more complicated feedback controller that includes anti-windup protection.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pi_update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{}):</span>
    <span class="c1"># Get the controller parameters that we need</span>
    <span class="n">ki</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ki&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">kaw</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kaw&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># anti-windup gain</span>

    <span class="c1"># Assign variables for inputs and states (for readability)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                    <span class="c1"># current velocity</span>
    <span class="n">vref</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>                 <span class="c1"># reference velocity</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                    <span class="c1"># integrated error</span>

    <span class="c1"># Compute the nominal controller output (needed for anti-windup)</span>
    <span class="n">u_a</span> <span class="o">=</span> <span class="n">pi_output</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="c1"># Compute anti-windup compensation (scale by ki to account for structure)</span>
    <span class="n">u_aw</span> <span class="o">=</span> <span class="n">kaw</span><span class="o">/</span><span class="n">ki</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">u_a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">u_a</span><span class="p">)</span> <span class="k">if</span> <span class="n">ki</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="c1"># State is the integrated error, minus anti-windup compensation</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">vref</span> <span class="o">-</span> <span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="n">u_aw</span>

<span class="k">def</span> <span class="nf">pi_output</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{}):</span>
    <span class="c1"># Get the controller parameters that we need</span>
    <span class="n">kp</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kp&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ki</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ki&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># Assign variables for inputs and states (for readability)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                    <span class="c1"># current velocity</span>
    <span class="n">vref</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>                 <span class="c1"># reference velocity</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                    <span class="c1"># integrated error</span>

    <span class="c1"># PI controller</span>
    <span class="k">return</span> <span class="n">kp</span> <span class="o">*</span> <span class="p">(</span><span class="n">vref</span> <span class="o">-</span> <span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="n">ki</span> <span class="o">*</span> <span class="n">z</span>

<span class="n">control_pi</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">NonlinearIOSystem</span><span class="p">(</span>
    <span class="n">pi_update</span><span class="p">,</span> <span class="n">pi_output</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;control&#39;</span><span class="p">,</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;vref&#39;</span><span class="p">],</span> <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span> <span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;kp&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;ki&#39;</span><span class="p">:</span><span class="mf">0.1</span><span class="p">})</span>

<span class="c1"># Create the closed loop system</span>
<span class="n">cruise_pi</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">InterconnectedSystem</span><span class="p">(</span>
    <span class="p">[</span><span class="n">vehicle</span><span class="p">,</span> <span class="n">control_pi</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cruise&#39;</span><span class="p">,</span>
    <span class="n">connections</span><span class="o">=</span><span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;vehicle.u&#39;</span><span class="p">,</span> <span class="s1">&#39;control.u&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;control.v&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.v&#39;</span><span class="p">]],</span>
    <span class="n">inplist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;control.vref&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.gear&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.theta&#39;</span><span class="p">],</span>
    <span class="n">outlist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;control.u&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle.v&#39;</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="Response-to-a-small-hill">
<h3>Response to a small hill<a class="headerlink" href="#Response-to-a-small-hill" title="Permalink to this heading">¶</a></h3>
<p>Figure 4.3b shows the response of the closed loop system. The figure shows that even if the hill is so steep that the throttle changes from 0.17 to almost full throttle, the largest speed error is less than 1 m/s, and the desired velocity is recovered after 20 s.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the equilibrium throttle setting for the desired speed</span>
<span class="n">X0</span><span class="p">,</span> <span class="n">U0</span><span class="p">,</span> <span class="n">Y0</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">find_eqpt</span><span class="p">(</span>
    <span class="n">cruise_pi</span><span class="p">,</span> <span class="p">[</span><span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gear</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">theta0</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
    <span class="n">y0</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">vref</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">iu</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">iy</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">return_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Now simulate the effect of a hill at t = 5 seconds</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Car with cruise control encountering sloping road&#39;</span><span class="p">)</span>
<span class="n">theta_hill</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">0</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">5</span> <span class="k">else</span>
    <span class="mf">4.</span><span class="o">/</span><span class="mf">180.</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">6</span> <span class="k">else</span>
    <span class="mf">4.</span><span class="o">/</span><span class="mf">180.</span> <span class="o">*</span> <span class="n">pi</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">T</span><span class="p">]</span>
<span class="n">t</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">input_output_response</span><span class="p">(</span>
    <span class="n">cruise_pi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">vref</span><span class="p">,</span> <span class="n">gear</span><span class="p">,</span> <span class="n">theta_hill</span><span class="p">],</span> <span class="n">X0</span><span class="p">)</span>
<span class="n">cruise_plot</span><span class="p">(</span><span class="n">cruise_pi</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t_hill</span><span class="o">=</span><span class="mi">5</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/cruise_25_0.png" src="_images/cruise_25_0.png" />
</div>
</div>
</div>
<div class="section" id="Effect-of-Windup">
<h3>Effect of Windup<a class="headerlink" href="#Effect-of-Windup" title="Permalink to this heading">¶</a></h3>
<p>The windup effect occurs when a car encounters a hill that is so steep (<span class="math">6^\circ</span>) that the throttle saturates when the cruise controller attempts to maintain speed.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Cruise control with integrator windup&#39;</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">vref</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">theta_hill</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">0</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">5</span> <span class="k">else</span>
    <span class="mf">6.</span><span class="o">/</span><span class="mf">180.</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">6</span> <span class="k">else</span>
    <span class="mf">6.</span><span class="o">/</span><span class="mf">180.</span> <span class="o">*</span> <span class="n">pi</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">T</span><span class="p">]</span>
<span class="n">t</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">input_output_response</span><span class="p">(</span>
    <span class="n">cruise_pi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">vref</span><span class="p">,</span> <span class="n">gear</span><span class="p">,</span> <span class="n">theta_hill</span><span class="p">],</span> <span class="n">X0</span><span class="p">,</span>
    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;kaw&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
<span class="n">cruise_plot</span><span class="p">(</span><span class="n">cruise_pi</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Commanded&#39;</span><span class="p">,</span> <span class="n">t_hill</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">antiwindup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/cruise_27_0.png" src="_images/cruise_27_0.png" />
</div>
</div>
</div>
<div class="section" id="PI-controller-with-anti-windup-compensation">
<h3>PI controller with anti-windup compensation<a class="headerlink" href="#PI-controller-with-anti-windup-compensation" title="Permalink to this heading">¶</a></h3>
<p>Anti-windup can be applied to the system to improve the response. Because of the feedback from the actuator model, the output of the integrator is quickly reset to a value such that the controller output is at the saturation limit.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Cruise control with integrator anti-windup protection&#39;</span><span class="p">)</span>
<span class="n">t</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">input_output_response</span><span class="p">(</span>
    <span class="n">cruise_pi</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="n">vref</span><span class="p">,</span> <span class="n">gear</span><span class="p">,</span> <span class="n">theta_hill</span><span class="p">],</span> <span class="n">X0</span><span class="p">,</span>
    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;kaw&#39;</span><span class="p">:</span><span class="mf">2.</span><span class="p">})</span>
<span class="n">cruise_plot</span><span class="p">(</span><span class="n">cruise_pi</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Commanded&#39;</span><span class="p">,</span> <span class="n">t_hill</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">antiwindup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/cruise_29_0.png" src="_images/cruise_29_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="era_msd.html" class="btn btn-neutral float-left" title="ERA example, mass spring damper system" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="describing_functions.html" class="btn btn-neutral float-right" title="Describing function analysis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, python-control.org.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>